---
title: "Example"
author: "Nathaniel Price"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(tvdiff)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette contains examples from the article "Numerical Differentiation of
Noisy, Nonsmooth Data" by Rick Chartrand (http://dx.doi.org/10.5402/2011/164564)

## A Simple Nonsmooth Example
A simple example based on the function $f(x) = \mid x - 0.5 \mid$ with 
Gaussian noise of standard deviation 0.05. The derivative is estimated from the 
noisy observations using Total Variation Regularized Differentiation. A
prediction of the original function is obtained from the estimated derivative 
through numerical integration.

```{r smallDemo, warning = FALSE, fig.height=4, fig.width=6}

# Load small demo data 
data("smalldemodata")

# Unpack data
x <- smalldemodata$x
obs <- smalldemodata$obs
true <- smalldemodata$true
dydx_true <- rep(-1, length(x))
dydx_true[x > 0.5] <- 1
dx <- x[2] - x[1]

# Extimate derivative
dydx <- TVRegDiffR(
  data = obs,
  iter = 1e3,
  alph = 0.2,
  scale = "small",
  ep = 1e-6,
  dx = dx
  )
dydx <- dydx[-1]

# Prediction
pred <- obs[1] + cumsum(dydx*dx)

# Plot observed vs predicted
plot(x, obs, pch = 20, col = "#57575F", ylab = "y")
lines(x, pred, col = "#CA3542", lty = 2, lwd = 2)
lines(x, true, col = "#27647B", lty = 1, lwd = 2)
legend("bottomleft", 
       legend = c("Predicted", "True"),
       col = c("#CA3542", "#27647B"),
       lty = 2:1,
       cex = 0.8,
       lwd = 2)

# Plot derivative
plot(x, dydx, type = "l", ylim = c(-1,1), col = "#CA3542", 
     ylab = expression(dy/dx), lty = 2, lwd = 2)
lines(x, dydx_true, col = "#27647B", lty = 1, lwd = 2)
legend("topleft", 
       legend = c("Predicted", "True"),
       col = c("#CA3542", "#27647B"),
       lty = 2:1,
       cex = 0.8,
       lwd = 2)

```

## Respirometry Data 
An example based on raw oxygen consumption data.

```{r largeDemo, fig.height=4, fig.width=6}

# Load data
data("largedemodata")

# Subsample data in order to use 'small' algorithm
ind <- seq(1, nrow(largedemodata), 1e2)
largedemodata <- largedemodata[ind, ]

# Unpack data
x <- largedemodata$x
obs <- largedemodata$obs
dx <- x[2] - x[1]

# Extimate derivative
dydx <- TVRegDiffR(
  data = obs,
  iter = 40,
  alph = 1e4,
  scale = "small",
  ep = 1e-6,
  dx = dx
  )
dydx <- dydx[-1]

# Prediction
pred <- obs[1] + cumsum(dydx*dx)

# Plot observed vs predicted
plot(x, obs, pch = 20, col = "#57575F", xlab = "x", ylab = "y")
lines(x, pred, col = "#CA3542", lty = 2, lwd = 2)
legend("topleft", 
       legend = c("Predicted"),
       col = c("#CA3542"),
       lty = 2:1,
       cex = 0.8,
       lwd = 2)

# Plot derivative
plot(x, dydx, type = "l", col = "#CA3542", ylab = expression(dy/dx))

```

## Toy example
A test dataset based on the piecewise function $f(x) = (x+2)^2$ when $x<0$ and
$f(x) = (x-2)^2$ when $x>0$ with Gaussian noise with a standard deviation of 0.5.

```{r toy, fig.height=4, fig.width=6}

# Load small demo data 
data("toyproblem")

# Unpack data
x <- toyproblem$x
dx <- x[2] - x[1]
y_obs <- toyproblem$y_obs
y_true <- toyproblem$y_true
dydx_true <- toyproblem$dydx_true


# Extimate derivative
dydx <- TVRegDiffR(
  data = y_obs,
  iter = 1e3,
  alph = 0.05,
  scale = "small",
  ep = 1e-6,
  dx = dx
  )
dydx <- dydx[-1]

# Prediction
y_pred <- y_obs[1] + cumsum(dydx*dx)

# Plot observed vs predicted
plot(x, y_obs, pch = 20, col = "#57575F", ylab = "y")
lines(x, y_pred, col = "#CA3542", lty = 2, lwd = 2)
lines(x, y_true, col = "#27647B", lty = 1, lwd = 2)
legend("bottomleft", 
       legend = c("Predicted", "True"),
       col = c("#CA3542", "#27647B"),
       lty = 2:1,
       cex = 0.8)

# Plot derivative
plot(x, dydx, type = "l", ylim = c(-4, 4), col = "#CA3542", 
     ylab = expression(dy/dx), lty = 2, lwd = 2)
lines(x, dydx_true, col = "#27647B", lty = 1, lwd = 2)
legend("topleft",
       legend = c("Predicted", "True"),
       col = c("#CA3542", "#27647B"),
       lty = 2:1,
       cex = 0.8)

```




